name: CD

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  quality:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install
        run: npm ci

      - name: Build
        run: npm run build

      - name: Test
        run: npm run test

      - name: Audit production dependencies (high+)
        run: npm audit --omit=dev --audit-level=high

  detect-changes:
    runs-on: ubuntu-latest
    needs: quality
    outputs:
      shared: ${{ steps.changes.outputs.shared }}
      query_api: ${{ steps.changes.outputs.query_api }}
      ingestion_worker: ${{ steps.changes.outputs.ingestion_worker }}
      mcp_server: ${{ steps.changes.outputs.mcp_server }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect deploy-relevant changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            shared:
              - package.json
              - package-lock.json
            query_api:
              - services/query-api/**
              - deploy/fly/query-api/**
            ingestion_worker:
              - services/ingestion-worker/**
              - deploy/fly/ingestion-worker/**
            mcp_server:
              - services/mcp-server/**
              - deploy/fly/mcp-server/**

  deploy-query-api-staging:
    runs-on: ubuntu-latest
    needs: [quality, detect-changes]
    if: ${{ secrets.FLY_API_TOKEN != '' && vars.FLY_STAGING_QUERY_API_APP != '' && (github.event_name == 'workflow_dispatch' || needs.detect-changes.outputs.shared == 'true' || needs.detect-changes.outputs.query_api == 'true') }}
    environment: staging
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1

      - name: Deploy query-api to staging
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: flyctl deploy --app "${{ vars.FLY_STAGING_QUERY_API_APP }}" --config deploy/fly/query-api/fly.toml --dockerfile deploy/fly/query-api/Dockerfile

      - name: Health check query-api staging
        env:
          APP_NAME: ${{ vars.FLY_STAGING_QUERY_API_APP }}
        run: |
          set -euo pipefail
          url="https://${APP_NAME}.fly.dev/v1/health"
          for i in 1 2 3 4 5 6; do
            if curl -fsS --max-time 10 "$url" >/dev/null; then
              echo "query-api staging healthy at $url"
              exit 0
            fi
            echo "attempt $i failed; retrying in 10s"
            sleep 10
          done
          echo "query-api staging health check failed: $url"
          exit 1

  deploy-query-api-production:
    runs-on: ubuntu-latest
    needs: [quality, detect-changes, deploy-query-api-staging]
    if: ${{ secrets.FLY_API_TOKEN != '' && vars.FLY_PROD_QUERY_API_APP != '' && (github.event_name == 'workflow_dispatch' || needs.detect-changes.outputs.shared == 'true' || needs.detect-changes.outputs.query_api == 'true') }}
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1

      - name: Deploy query-api to production
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: flyctl deploy --app "${{ vars.FLY_PROD_QUERY_API_APP }}" --config deploy/fly/query-api/fly.toml --dockerfile deploy/fly/query-api/Dockerfile

  deploy-ingestion-worker-staging:
    runs-on: ubuntu-latest
    needs: [quality, detect-changes]
    if: ${{ secrets.FLY_API_TOKEN != '' && vars.FLY_STAGING_INGESTION_WORKER_APP != '' && (github.event_name == 'workflow_dispatch' || needs.detect-changes.outputs.shared == 'true' || needs.detect-changes.outputs.ingestion_worker == 'true') }}
    environment: staging
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1

      - name: Deploy ingestion-worker to staging
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: flyctl deploy --app "${{ vars.FLY_STAGING_INGESTION_WORKER_APP }}" --config deploy/fly/ingestion-worker/fly.toml --dockerfile deploy/fly/ingestion-worker/Dockerfile

      - name: Health check ingestion-worker staging
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          APP_NAME: ${{ vars.FLY_STAGING_INGESTION_WORKER_APP }}
        run: |
          set -euo pipefail
          flyctl machines list --app "$APP_NAME" --json > machines.json
          node -e "const fs=require('fs'); const machines=JSON.parse(fs.readFileSync('machines.json','utf8')); const healthy=machines.some(m=>['started','running'].includes(String(m.state).toLowerCase())); if(!healthy){console.error('No running machine found for '+process.env.APP_NAME); process.exit(1);} console.log('ingestion-worker staging has running machine(s)');"

  deploy-ingestion-worker-production:
    runs-on: ubuntu-latest
    needs: [quality, detect-changes, deploy-ingestion-worker-staging]
    if: ${{ secrets.FLY_API_TOKEN != '' && vars.FLY_PROD_INGESTION_WORKER_APP != '' && (github.event_name == 'workflow_dispatch' || needs.detect-changes.outputs.shared == 'true' || needs.detect-changes.outputs.ingestion_worker == 'true') }}
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1

      - name: Deploy ingestion-worker to production
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: flyctl deploy --app "${{ vars.FLY_PROD_INGESTION_WORKER_APP }}" --config deploy/fly/ingestion-worker/fly.toml --dockerfile deploy/fly/ingestion-worker/Dockerfile

  deploy-mcp-server-staging:
    runs-on: ubuntu-latest
    needs: [quality, detect-changes]
    if: ${{ secrets.FLY_API_TOKEN != '' && vars.FLY_STAGING_MCP_SERVER_APP != '' && (github.event_name == 'workflow_dispatch' || needs.detect-changes.outputs.shared == 'true' || needs.detect-changes.outputs.mcp_server == 'true') }}
    environment: staging
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1

      - name: Deploy mcp-server to staging
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: flyctl deploy --app "${{ vars.FLY_STAGING_MCP_SERVER_APP }}" --config deploy/fly/mcp-server/fly.toml --dockerfile deploy/fly/mcp-server/Dockerfile

      - name: Health check mcp-server staging
        env:
          APP_NAME: ${{ vars.FLY_STAGING_MCP_SERVER_APP }}
        run: |
          set -euo pipefail
          url="https://${APP_NAME}.fly.dev/health"
          for i in 1 2 3 4 5 6; do
            if curl -fsS --max-time 10 "$url" >/dev/null; then
              echo "mcp-server staging healthy at $url"
              exit 0
            fi
            echo "attempt $i failed; retrying in 10s"
            sleep 10
          done
          echo "mcp-server staging health check failed: $url"
          exit 1

  deploy-mcp-server-production:
    runs-on: ubuntu-latest
    needs: [quality, detect-changes, deploy-mcp-server-staging]
    if: ${{ secrets.FLY_API_TOKEN != '' && vars.FLY_PROD_MCP_SERVER_APP != '' && (github.event_name == 'workflow_dispatch' || needs.detect-changes.outputs.shared == 'true' || needs.detect-changes.outputs.mcp_server == 'true') }}
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1

      - name: Deploy mcp-server to production
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: flyctl deploy --app "${{ vars.FLY_PROD_MCP_SERVER_APP }}" --config deploy/fly/mcp-server/fly.toml --dockerfile deploy/fly/mcp-server/Dockerfile
